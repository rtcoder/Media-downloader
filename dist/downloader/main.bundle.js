(()=>{"use strict";var t;!function(t){t.IMAGE="image",t.AUDIO="audio",t.VIDEO="video"}(t||(t={}));var e,n,o,i,c=function(t,e,n,o){return new(n||(n=Promise))((function(i,c){function s(t){try{a(o.next(t))}catch(t){c(t)}}function r(t){try{a(o.throw(t))}catch(t){c(t)}}function a(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,r)}a((o=o.apply(t,e||[])).next())}))};function s(){return c(this,void 0,void 0,(function*(){var t,e;try{let n={active:!0,lastFocusedWindow:!0},[o]=yield chrome.tabs.query(n);return console.log("current tabUrl: ",null==o?void 0:o.url,o),!(null==o?void 0:o.url)||(null===(t=null==o?void 0:o.url)||void 0===t?void 0:t.startsWith("chrome://"))||(null===(e=null==o?void 0:o.url)||void 0===e?void 0:e.startsWith("https://chromewebstore.google.com"))?null:o}catch(t){return null}}))}function r(t){return c(this,void 0,void 0,(function*(){var e,n;try{const o=yield chrome.tabs.get(t);return chrome.runtime.lastError?(console.error("Error get tab by ID:",chrome.runtime.lastError),null):(console.log("tabUrl: ",null==o?void 0:o.url),!(null==o?void 0:o.url)||(null===(e=null==o?void 0:o.url)||void 0===e?void 0:e.startsWith("chrome://"))||(null===(n=null==o?void 0:o.url)||void 0===n?void 0:n.startsWith("https://chromewebstore.google.com"))?null:o)}catch(t){return null}}))}function a(t,e){chrome.storage.sync.get(t,e)}function l(t,e){e?chrome.storage.sync.set(t,e):chrome.storage.sync.set(t)}(i=e||(e={})).LIGHT="light",i.DARK="dark",i.SYSTEM="system",(o=n||(n={})).POPUP="popup",o.SIDE_PANEL="side-panel";const d={theme:e.SYSTEM,defaultAction:n.POPUP,previousVersion:null,showChangelogLink:!1,lastOpenSection:t.IMAGE};function u(t,e,n=null){let o=[];o="string"==typeof t?function(t){const e=[],n=document.querySelectorAll(t);return n.forEach((t=>e.push(t))),n}(t):Array.isArray(t)?[...t]:[t],o.length&&(null===n?[...o].forEach((t=>{t.classList.contains(e)?t.classList.remove(e):t.classList.add(e)})):n?[...o].forEach((t=>t.classList.add(e))):[...o].forEach((t=>t.classList.remove(e))))}function h(t,e={},n=[]){const o=document.createElement(t);if(e.class&&("string"==typeof e.class?o.classList.add(e.class):o.classList.add(...e.class)),e.html&&(o.innerHTML=e.html||""),e.attributes)for(const[t,n]of Object.entries(e.attributes))o.setAttribute(t,n);if(e.data)for(const[t,n]of Object.entries(e.data))o.setAttribute(`data-${t}`,n);return e.type&&(o.type=e.type),e.title&&(o.title=e.title),e.alt&&(o.alt=e.alt),e.src&&(o.src=e.src),n&&(!Array.isArray(n)&&n instanceof HTMLElement&&(n=[n]),o.append(...n)),o}function f(t={},e=[]){return h("div",t,e)}function m(t={},e=[]){return h("span",t,e)}function p(t={},e=[]){return t.type="button",h("button",t,e)}function b(t={}){return h("img",t)}function g(t,e=24){return m({html:t,class:"x-icon",attributes:{size:e}})}function v(t){return document.querySelector(t)}Object.keys(d);const y=[],E={},A={};function I(){return f({class:"thumbnail"})}function w(e,n,o,i){const c=f({class:"accordion-body"});return i?(c.appendChild(f({class:"yt-info"},[m({html:"Note: Chrome Web Store does not allow extensions that download videos from YouTube any longer."}),h("a",{href:"https://developer.chrome.com/docs/webstore/troubleshooting/#prohibited-products",html:"Chrome policy"})])),c.classList.add("restricted")):c.append(...e.map((e=>function(e,n){const{src:o,alt:i,poster:c,type:s,selected:r,filetype:a}=e,l=f({class:["grid-item",...r?["checked"]:[]],attributes:{"data-src-dw":o,"data-filename":(null==i?void 0:i.length)?i:"","data-item-idx":n,"data-type":s}}),d=p({class:"download_image_button"},g("download")),u=h("a",{attributes:{href:e.src,download:e.alt||""}},d),v=m({class:"item-details-dimensions"}),y=m({class:"item-details"},[m({class:"item-details-ext",html:a}),v]);let E=null;switch(s){case t.IMAGE:v.textContent=`${e.properties.width} x ${e.properties.height}`,E=function(t){const e=I(),n=b({src:t});return e.appendChild(n),e}(o);break;case t.AUDIO:v.textContent=e.properties.duration,E=function(){const t=I(),e=g("music_note",50);return t.appendChild(e),t}();break;case t.VIDEO:v.textContent=e.properties.duration,E=function(t){const e=I(),n=g("videocam",50),o=b({src:t});return e.appendChild(t?o:n),e}(c)}return l.appendChild(u),l.appendChild(y),E&&l.appendChild(E),l}(e,`${n}-${o}-${e.uuid}`)))),c}function T(t){const e=v(".accordion");e.innerHTML="",t.forEach((t=>{e.appendChild(function(t){const e=f({class:"accordion-group",attributes:{"data-tab-subgroup":t.tabId}});return t.data.forEach((t=>{e.appendChild(function(t){const{title:e,uuid:n,id:o,favIconUrl:i,isRestricted:c}=A[t.tabUuid],s=f({class:["accordion-item",...E[n]?["active"]:[]]});s.setAttribute("tab-uuid",n);const r=(a=i,l=e,d=t.items.length,f({class:"accordion-header"},p({class:"accordion-button"},[b({src:a,class:"favicon",alt:"Favicon"}),m({class:"tab-title"},[m({class:"title",html:l}),m({class:"tab-media-count",html:`(${d})`})]),m({class:"tab-toggle"})])));var a,l,d;const u=w(t.items,o,n,c);return s.appendChild(r),s.appendChild(u),s}(t))})),e}(t))}))}const k=(()=>{let t;const e=[];for(let n=0;n<256;n++){t=n;for(let e=0;e<8;e++)t=1&t?3988292384^t>>>1:t>>>1;e[n]=t}return e})();function C(t){return function(t){let e=-1;for(let n=0;n<t.length;n++)e=e>>>8^k[255&(e^t.charCodeAt(n))];return~e>>>0}(t.toString()).toString(16).padStart(8,"0")}function L(){const e=v(".section-buttons button.selected").getAttribute("data-section")||t.IMAGE;return y.map((t=>{const n=t.elements.map((({media:t,tabUuid:n})=>{const o=(t=>t[e].map((t=>function(t,e){const{properties:n,src:o,uuid:i,poster:c,type:s,selected:r,alt:a}=t;return{properties:n,src:o,uuid:i,poster:c,filetype:s,selected:r,type:e,alt:a}}(t,e))))(t);return{tabUuid:n,items:o}}));return{tabId:t.tabId,data:n}}))}function x(){const t=L();console.log(t),T(t),v(".count-all").innerHTML=function(t){return t.reduce(((t,e)=>t+e.data.reduce(((t,e)=>t+e.items.length),0)),0)}(t).toString()}function D(t,e){E[t]=e}function _(t){!function(t,e=null){const n={url:t};e&&(n.filename=e),chrome.downloads.download(n)}(t.url,t.alt)}const S=[t.IMAGE,t.AUDIO,t.VIDEO];function M(t){const{checked:e}=t.target;let n=!0,o=!0;const i=L();let c=0;u(".grid-item","checked",e);for(let t=0;t<i.length;t++){const{data:s}=i[t];for(let t=0;t<s.length;t++){const{items:i}=s[t];for(let t=0;t<i.length;t++)i[t].selected=e,i[t].selected?(o=!1,c++):n=!1}}U(c);const s=v("#toggle_all_checkbox");s.indeterminate=!(n||o),n?s.checked=!0:o&&(s.checked=!1)}function U(t){var e;v("#download-btn .selected-count").innerHTML=t>0?`(${t})`:"",e=!t,v("#download-btn").disabled=e}function O(e){l({lastOpenSection:e=S.includes(e)?e:t.IMAGE}),u(".section-buttons button","selected",!1),u(`.section-buttons button[data-section="${e}"]`,"selected",!0)}function P(t=null){!function(t){c(this,arguments,void 0,(function*(t,e=null){if(!e){const t=yield s();if(!t||!t.id)return;if(t.id<=0)return;e=t.id}yield chrome.scripting.executeScript({target:{tabId:e,allFrames:!0},files:[t]})}))}("/dist/content-script/send_media.bundle.js",t)}var $;!function(t){t.TAB_CREATED="tabCreated",t.TAB_REPLACED="tabReplaced",t.TAB_UPDATED="tabUpdated",t.TAB_ACTIVATED="tabActivated",t.SEND_MEDIA="sendMedia",t.GET_TAB_INFO="getTabInfo"}($||($={}));const B=["https://youtube.com","https://www.youtube.com"];function G(t){return B.some((e=>t.includes(e)))}function R(t){return e=this,n=void 0,i=function*(){if(t.error&&Object.keys(t.error).length>0)return void console.log(t);const e=t.tabInfo||(yield s());if(!e)return;const n={image:[],video:[],audio:[]};!function(t){const e=C(`${t.id}-${t.url}`);A[e]={id:t.id,favIconUrl:t.favIconUrl,url:t.url,title:t.title,isRestricted:G(t.url),uuid:e}}(e);const o=C(`${e.id}-${e.url}`),i=G(e.url);let c=function(t){let e=y.findIndex((({tabId:t})=>t==t));return-1===e&&(y.push({tabId:t,elements:[]}),e=y.length-1),e}(e.id);if(i)return void x();const r=function(t,e){let n=y[e].elements.findIndex((e=>e.tabUuid===t));return-1===n&&(y[e].elements.push({media:{image:[],video:[],audio:[]},tabUuid:t}),n=y[e].elements.length-1),n}(o,c),{media:a}=y[c].elements[r],l={image:t.image,audio:t.audio,video:t.video};S.filter((t=>!!l[t])).forEach((t=>{var e;l[t].forEach((e=>n[t].push(e))),y[c].elements[r].media[t]=(e=[...a[t],...n[t]],[...new Map(e.map((t=>[t.src,t]))).values()])})),console.log({mediaInTabs:y}),function(){let t={image:0,audio:0,video:0};y.forEach((e=>{e.elements.forEach((e=>{D(e.tabUuid,!1),S.forEach((n=>{t[n]+=e.media[n].length}))}))})),S.forEach((e=>{v(`.section-buttons button[data-section="${e}"] .items-count`).innerHTML=t[e].toString()}))}(),D(o,!0),x()},new((o=void 0)||(o=Promise))((function(t,c){function s(t){try{a(i.next(t))}catch(t){c(t)}}function r(t){try{a(i.throw(t))}catch(t){c(t)}}function a(e){var n;e.done?t(e.value):(n=e.value,n instanceof o?n:new o((function(t){t(n)}))).then(s,r)}a((i=i.apply(e,n||[])).next())}));var e,n,o,i}var H,N=function(t,e,n,o){return new(n||(n=Promise))((function(i,c){function s(t){try{a(o.next(t))}catch(t){c(t)}}function r(t){try{a(o.throw(t))}catch(t){c(t)}}function a(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,r)}a((o=o.apply(t,e||[])).next())}))};P(),function(){var t;t=t=>{const{eventName:e,data:n}=t;switch(console.log(e,n),e){case $.TAB_UPDATED:n.tabId,o=n.changeInfo,(i=n.tab).active&&"complete"===o.status&&P(i.id);break;case $.TAB_ACTIVATED:!function(t){N(this,void 0,void 0,(function*(){const e=yield r(t);e&&e.active&&P(t)}))}(n.tabId);break;case $.TAB_CREATED:!function(t){t.active&&P(t.id)}(n.tab);break;case $.TAB_REPLACED:!function(t){N(this,void 0,void 0,(function*(){const e=yield r(t);e&&e.active&&P(t)}))}(n.tabId);break;case $.SEND_MEDIA:R(n)}var o,i},chrome.runtime.onMessage.addListener(t)}(),document.body.addEventListener("click",(t=>{const{target:e}=t;if(e)if(e.closest("#download-btn"))!function(t){const e=[];for(let n=0;n<t.length;n++){const{data:o}=t[n];for(let t=0;t<o.length;t++){const{items:n}=o[t];for(let t=0;t<n.length;t++)n[t].selected&&e.push({url:n[t].src,alt:n[t].alt})}}e.forEach(_)}(L());else{if(e.closest(".section-buttons button"))return O(e.closest(".section-buttons button").getAttribute("data-section")),void x();if(e.matches(".thumbnail"))!function(t){const e=t.closest(".grid-item"),n=e.getAttribute("data-item-idx"),o=e.getAttribute("data-type"),i=!e.classList.contains("checked");u(e,"checked");const[c,s,r]=n.split("-"),a=y.findIndex((({tabId:t})=>t===+c)),l=y[a].elements.findIndex((t=>t.tabUuid===s));if(-1===l)return;y[a].elements[l].media[o][+r].selected=i;let d=!0,h=!0;const f=L();let m=0;console.log(n,i);for(let t=0;t<f.length;t++){const{data:e}=f[t];for(let t=0;t<e.length;t++){const{items:n}=e[t];for(let t=0;t<n.length;t++)n[t].selected?(h=!1,m++):d=!1}}U(m);const p=v("#toggle_all_checkbox");p.indeterminate=!(d||h),d?p.checked=!0:h&&(p.checked=!1)}(e);else if(e.matches(".yt-info a"))window.open("https://developer.chrome.com/docs/webstore/troubleshooting/#prohibited-products");else{if(e.matches(".changelog-link"))return l({showChangelogLink:!1}),n={url:"views/changelog.html"},chrome.tabs.create(n),void function(t){const e="string"==typeof t?v(t):t;e&&(e.hidden=!0)}(e);var n;e.closest(".accordion-header")&&u(e.closest(".accordion-header").closest(".accordion-item"),"active")}}})),v("#toggle_all_checkbox").addEventListener("change",M),H=t=>{t&&function(t){const e=v(t);e&&(e.hidden=!1)}(".changelog-link")},a({showChangelogLink:!1},(({showChangelogLink:t})=>{H(!!t)})),a({lastOpenSection:t.IMAGE},(({lastOpenSection:t})=>{t||(t=d.lastOpenSection),(t=>{O(t)})(t)}))})();
//# sourceMappingURL=main.bundle.js.map