(()=>{"use strict";var t;!function(t){t.IMAGE="image",t.AUDIO="audio",t.VIDEO="video"}(t||(t={}));var e,n,o,i,c=function(t,e,n,o){return new(n||(n=Promise))((function(i,c){function a(t){try{s(o.next(t))}catch(t){c(t)}}function r(t){try{s(o.throw(t))}catch(t){c(t)}}function s(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(a,r)}s((o=o.apply(t,e||[])).next())}))};function a(){return c(this,void 0,void 0,(function*(){var t,e;try{let n={active:!0,lastFocusedWindow:!0},[o]=yield chrome.tabs.query(n);return console.log("current tabUrl: ",null==o?void 0:o.url,o),!(null==o?void 0:o.url)||(null===(t=null==o?void 0:o.url)||void 0===t?void 0:t.startsWith("chrome://"))||(null===(e=null==o?void 0:o.url)||void 0===e?void 0:e.startsWith("https://chromewebstore.google.com"))?null:o}catch(t){return null}}))}function r(t){return c(this,void 0,void 0,(function*(){var e,n;try{const o=yield chrome.tabs.get(t);return chrome.runtime.lastError?(console.error("Error get tab by ID:",chrome.runtime.lastError),null):(console.log("tabUrl: ",null==o?void 0:o.url),!(null==o?void 0:o.url)||(null===(e=null==o?void 0:o.url)||void 0===e?void 0:e.startsWith("chrome://"))||(null===(n=null==o?void 0:o.url)||void 0===n?void 0:n.startsWith("https://chromewebstore.google.com"))?null:o)}catch(t){return null}}))}function s(t,e){chrome.storage.sync.get(t,e)}function l(t,e){e?chrome.storage.sync.set(t,e):chrome.storage.sync.set(t)}(i=e||(e={})).LIGHT="light",i.DARK="dark",i.SYSTEM="system",(o=n||(n={})).POPUP="popup",o.SIDE_PANEL="side-panel";const d={theme:e.SYSTEM,defaultAction:n.POPUP,previousVersion:null,showChangelogLink:!1,lastOpenSection:t.IMAGE};function u(t,e,n=null){let o=[];o="string"==typeof t?function(t){const e=[],n=document.querySelectorAll(t);return n.forEach((t=>e.push(t))),n}(t):Array.isArray(t)?[...t]:[t],o.length&&(null===n?[...o].forEach((t=>{t.classList.contains(e)?t.classList.remove(e):t.classList.add(e)})):n?[...o].forEach((t=>t.classList.add(e))):[...o].forEach((t=>t.classList.remove(e))))}function h(t,e={},n=[]){const o=document.createElement(t);if(e.class&&("string"==typeof e.class?o.classList.add(e.class):o.classList.add(...e.class)),e.html&&(o.innerHTML=e.html||""),e.attributes)for(const[t,n]of Object.entries(e.attributes))o.setAttribute(t,n);if(e.data)for(const[t,n]of Object.entries(e.data))o.setAttribute(`data-${t}`,n);return e.type&&(o.type=e.type),e.title&&(o.title=e.title),e.alt&&(o.alt=e.alt),e.src&&(o.src=e.src),n&&(!Array.isArray(n)&&n instanceof HTMLElement&&(n=[n]),o.append(...n)),o}function f(t={},e=[]){return h("div",t,e)}function m(t={},e=[]){return h("span",t,e)}function b(t={},e=[]){return t.type="button",h("button",t,e)}function g(t={}){return h("img",t)}function p(t,e=24){return m({html:t,class:"x-icon",attributes:{size:e}})}function v(t){return document.querySelector(t)}Object.keys(d);const y=[],A={},E={},w=(()=>{let t;const e=[];for(let n=0;n<256;n++){t=n;for(let e=0;e<8;e++)t=1&t?3988292384^t>>>1:t>>>1;e[n]=t}return e})();function I(t){return function(t){let e=-1;for(let n=0;n<t.length;n++)e=e>>>8^w[255&(e^t.charCodeAt(n))];return~e>>>0}(t.toString()).toString(16).padStart(8,"0")}function k(){return f({class:"thumbnail"})}function C(t,e){const{src:n,alt:o,poster:i,type:c,selected:a,filetype:r}=t,s=f({class:["grid-item",...a?["checked"]:[]],attributes:{"data-src-dw":n,"data-filename":(null==o?void 0:o.length)?o:"","data-item-idx":e,"data-type":c}}),l=b({class:"download_image_button"},p("download")),d=h("a",{attributes:{href:t.src,download:t.alt||""}},l),u=m({class:"item-details"},[m({class:"item-details-ext",html:r}),m({class:"item-details-dimensions"})]);let v=null;switch(c){case"image":v=function(t){const e=k(),n=g({src:t});return e.appendChild(n),e}(n);break;case"audio":v=function(t){const e=k(),n=p("music_note",50),o=h("audio",{src:t});return e.appendChild(n),e.appendChild(o),e}(n);break;case"video":v=function(t,e){const n=k(),o=p("videocam",50),i=g({src:e}),c=h("video",{src:t,poster:e});return n.appendChild(e?i:o),n.appendChild(c),n}(n,i)}s.appendChild(d),s.appendChild(u),v&&(s.appendChild(v),function(t,e){switch(e){case"image":(i=t.querySelector("img")).addEventListener("load",(()=>{const t=i.naturalWidth.toString(),e=i.naturalHeight.toString(),n=i.closest(".grid-item");null==n||n.setAttribute("original-width",t),null==n||n.setAttribute("original-height",e)}));break;case"audio":(n=t.querySelector("audio")).addEventListener("loadedmetadata",(()=>{const t=function(t){const e=Math.floor(t%60),n=Math.floor(t%3600/60),o=Math.floor(t/3600),i=e<10?`0${e}`:e,c=n<10?`0${n}`:n;return o>0?`${o}:${c}:${i}`:`${c}:${i}`}(n.duration),e=n.closest(".grid-item");null==e||e.setAttribute("audio-duration",t),n.remove()}));break;case"video":(o=t.querySelector("video")).addEventListener("loadedmetadata",(()=>{const t=(e=o.videoWidth)>=3840?"4K":e>=2560?"1440p":e>=1920?"1080p":e>=1280?"720p":e>=854?"480p":e>=640?"360p":"SD";var e;const n=o.closest(".grid-item");null==n||n.setAttribute("video-quality",t),o.remove()}))}var n,o,i}(v,c));const y=new MutationObserver((t=>{t.forEach((t=>{"attributes"===t.type&&function(t,e,n){const o=t.querySelector(".item-details").querySelector(".item-details-dimensions"),i=t.getAttribute("audio-duration"),c=t.getAttribute("original-width"),a=t.getAttribute("original-height"),r=t.getAttribute("video-quality");switch(console.log({duration:i,width:c,height:a,quality:r}),e){case"audio":o.textContent=i,i&&n.disconnect();break;case"image":o.textContent=`${c} x ${a}`,c&&a&&n.disconnect();break;case"video":o.textContent=r,r&&n.disconnect()}}(s,c,y)}))}));return y.observe(s,{attributes:!0,attributeFilter:["audio-duration","video-quality","original-width","original-height"]}),s}function L(t){const{title:e,uuid:n,id:o,favIconUrl:i,isRestricted:c}=E[t.tabUuid],a=f({class:["accordion-item",...A[n]?["active"]:[]]});a.setAttribute("tab-uuid",n);const r=(s=i,l=e,d=t.items.length,f({class:"accordion-header"},b({class:"accordion-button"},[g({src:s,class:"favicon",alt:"Favicon"}),m({class:"tab-title"},[m({class:"title",html:l}),m({class:"tab-media-count",html:`(${d})`})]),m({class:"tab-toggle"})])));var s,l,d;const u=function(t,e,n,o){const i=f({class:"accordion-body"});return o?(i.appendChild(f({class:"yt-info"},[m({html:"Note: Chrome Web Store does not allow extensions that download videos from YouTube any longer."}),h("a",{href:"https://developer.chrome.com/docs/webstore/troubleshooting/#prohibited-products",html:"Chrome policy"})])),i.classList.add("restricted")):i.append(...t.map((t=>C(t,`${e}-${n}-${t.uuid}`)))),i}(t.items,o,n,c);return a.appendChild(r),a.appendChild(u),a}function S(){const t=v(".section-buttons button.selected").getAttribute("data-section")||"image";return y.map((e=>{const n=e.elements.map((({media:e,tabUuid:n})=>{const o=(e=>e[t].map((e=>function(t,e){const{src:n,uuid:o,poster:i,type:c,selected:a,alt:r}=t;return{src:n,uuid:o,poster:i,filetype:c,selected:a,type:e,alt:r}}(e,t))))(e);return{tabUuid:n,items:o}}));return{tabId:e.tabId,data:n}}))}function T(){const t=S();console.log(t),function(t){const e=v(".accordion");e.innerHTML="",t.forEach((t=>{e.appendChild(function(t){const e=f({class:"accordion-group",attributes:{"data-tab-subgroup":t.tabId}});return t.data.forEach((t=>{e.appendChild(L(t))})),e}(t))}))}(t),v(".count-all").innerHTML=function(t){return t.reduce(((t,e)=>t+e.data.reduce(((t,e)=>t+e.items.length),0)),0)}(t).toString()}function x(t,e){A[t]=e}function _(t){!function(t,e=null){const n={url:t};e&&(n.filename=e),chrome.downloads.download(n)}(t.url,t.alt)}const D=[t.IMAGE,t.AUDIO,t.VIDEO];function M(t){const{checked:e}=t.target;let n=!0,o=!0;const i=S();let c=0;u(".grid-item","checked",e);for(let t=0;t<i.length;t++){const{data:a}=i[t];for(let t=0;t<a.length;t++){const{items:i}=a[t];for(let t=0;t<i.length;t++)i[t].selected=e,i[t].selected?(o=!1,c++):n=!1}}$(c);const a=v("#toggle_all_checkbox");a.indeterminate=!(n||o),n?a.checked=!0:o&&(a.checked=!1)}function $(t){var e;v("#download-btn .selected-count").innerHTML=t>0?`(${t})`:"",e=!t,v("#download-btn").disabled=e}function U(e){l({lastOpenSection:e=D.includes(e)?e:t.IMAGE}),u(".section-buttons button","selected",!1),u(`.section-buttons button[data-section="${e}"]`,"selected",!0)}function O(t=null){!function(t){c(this,arguments,void 0,(function*(t,e=null){if(!e){const t=yield a();if(!t||!t.id)return;if(t.id<=0)return;e=t.id}yield chrome.scripting.executeScript({target:{tabId:e,allFrames:!0},files:[t]})}))}("/dist/content-script/send_media.bundle.js",t)}var P;!function(t){t.TAB_CREATED="tabCreated",t.TAB_REPLACED="tabReplaced",t.TAB_UPDATED="tabUpdated",t.TAB_ACTIVATED="tabActivated",t.SEND_MEDIA="sendMedia",t.GET_TAB_INFO="getTabInfo"}(P||(P={}));const q=["https://youtube.com","https://www.youtube.com"];function B(t){return q.some((e=>t.includes(e)))}function H(t){return e=this,n=void 0,i=function*(){if(t.error&&Object.keys(t.error).length>0)return void console.log(t);const e=t.tabInfo||(yield a());if(!e)return;const n={image:[],video:[],audio:[]};!function(t){const e=I(`${t.id}-${t.url}`);E[e]={id:t.id,favIconUrl:t.favIconUrl,url:t.url,title:t.title,isRestricted:B(t.url),uuid:e}}(e);const o=I(`${e.id}-${e.url}`),i=B(e.url);let c=function(t){let e=y.findIndex((({tabId:t})=>t==t));return-1===e&&(y.push({tabId:t,elements:[]}),e=y.length-1),e}(e.id);if(i)return void T();const r=function(t,e){let n=y[e].elements.findIndex((e=>e.tabUuid===t));return-1===n&&(y[e].elements.push({media:{image:[],video:[],audio:[]},tabUuid:t}),n=y[e].elements.length-1),n}(o,c),{media:s}=y[c].elements[r],l={image:t.image,audio:t.audio,video:t.video};D.filter((t=>!!l[t])).forEach((t=>{var e;l[t].filter((e=>!n[t].includes(e))).forEach((e=>n[t].push(e))),y[c].elements[r].media[t]=(e=[...s[t],...n[t]],[...new Map(e.map((t=>[t.src,t]))).values()])})),x(o,!0),function(){let t={image:0,audio:0,video:0};y.forEach((e=>{e.elements.forEach((e=>{x(e.tabUuid,!1),D.forEach((n=>{t[n]+=e.media[n].length}))}))})),D.forEach((e=>{v(`.section-buttons button[data-section="${e}"] .items-count`).innerHTML=t[e].toString()}))}(),T()},new((o=void 0)||(o=Promise))((function(t,c){function a(t){try{s(i.next(t))}catch(t){c(t)}}function r(t){try{s(i.throw(t))}catch(t){c(t)}}function s(e){var n;e.done?t(e.value):(n=e.value,n instanceof o?n:new o((function(t){t(n)}))).then(a,r)}s((i=i.apply(e,n||[])).next())}));var e,n,o,i}var R,W=function(t,e,n,o){return new(n||(n=Promise))((function(i,c){function a(t){try{s(o.next(t))}catch(t){c(t)}}function r(t){try{s(o.throw(t))}catch(t){c(t)}}function s(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(a,r)}s((o=o.apply(t,e||[])).next())}))};O(),function(){var t;t=t=>{const{eventName:e,data:n}=t;switch(console.log(e,n),e){case P.TAB_UPDATED:n.tabId,o=n.changeInfo,(i=n.tab).active&&"complete"===o.status&&O(i.id);break;case P.TAB_ACTIVATED:!function(t){W(this,void 0,void 0,(function*(){const e=yield r(t);e&&e.active&&O(t)}))}(n.tabId);break;case P.TAB_CREATED:!function(t){t.active&&O(t.id)}(n.tab);break;case P.TAB_REPLACED:!function(t){W(this,void 0,void 0,(function*(){const e=yield r(t);e&&e.active&&O(t)}))}(n.tabId);break;case P.SEND_MEDIA:H(n)}var o,i},chrome.runtime.onMessage.addListener(t)}(),document.body.addEventListener("click",(t=>{const{target:e}=t;if(e)if(e.closest("#download-btn"))!function(t){const e=[];for(let n=0;n<t.length;n++){const{data:o}=t[n];for(let t=0;t<o.length;t++){const{items:n}=o[t];for(let t=0;t<n.length;t++)n[t].selected&&e.push({url:n[t].src,alt:n[t].alt})}}e.forEach(_)}(S());else{if(e.closest(".section-buttons button"))return U(e.closest(".section-buttons button").getAttribute("data-section")),void T();if(e.matches(".thumbnail"))!function(t){const e=t.closest(".grid-item"),n=e.getAttribute("data-item-idx"),o=e.getAttribute("data-type"),i=!e.classList.contains("checked");u(e,"checked");const[c,a,r]=n.split("-"),s=y.findIndex((({tabId:t})=>t===+c)),l=y[s].elements.findIndex((t=>t.tabUuid===a));if(-1===l)return;y[s].elements[l].media[o][+r].selected=i;let d=!0,h=!0;const f=S();let m=0;console.log(n,i);for(let t=0;t<f.length;t++){const{data:e}=f[t];for(let t=0;t<e.length;t++){const{items:n}=e[t];for(let t=0;t<n.length;t++)n[t].selected?(h=!1,m++):d=!1}}$(m);const b=v("#toggle_all_checkbox");b.indeterminate=!(d||h),d?b.checked=!0:h&&(b.checked=!1)}(e);else if(e.matches(".yt-info a"))window.open("https://developer.chrome.com/docs/webstore/troubleshooting/#prohibited-products");else{if(e.matches(".changelog-link"))return l({showChangelogLink:!1}),n={url:"views/changelog.html"},chrome.tabs.create(n),void function(t){const e="string"==typeof t?v(t):t;e&&(e.hidden=!0)}(e);var n;e.closest(".accordion-header")&&u(e.closest(".accordion-header").closest(".accordion-item"),"active")}}})),v("#toggle_all_checkbox").addEventListener("change",M),R=t=>{t&&function(t){const e=v(t);e&&(e.hidden=!1)}(".changelog-link")},s({showChangelogLink:!1},(({showChangelogLink:t})=>{R(!!t)})),s({lastOpenSection:t.IMAGE},(({lastOpenSection:t})=>{t||(t=d.lastOpenSection),(t=>{U(t)})(t)}))})();
//# sourceMappingURL=main.bundle.js.map