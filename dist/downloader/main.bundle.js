(()=>{"use strict";function t(t,e,n=null){let o=[];o="string"==typeof t?function(t){const e=[],n=document.querySelectorAll(t);return n.forEach((t=>e.push(t))),n}(t):Array.isArray(t)?[...t]:[t],o.length&&(null===n?[...o].forEach((t=>{t.classList.contains(e)?t.classList.remove(e):t.classList.add(e)})):n?[...o].forEach((t=>t.classList.add(e))):[...o].forEach((t=>t.classList.remove(e))))}function e(t,e={},n=[]){const o=document.createElement(t);if(e.class&&("string"==typeof e.class?o.classList.add(e.class):o.classList.add(...e.class)),e.html&&(o.innerHTML=e.html||""),e.attributes)for(const[t,n]of Object.entries(e.attributes))o.setAttribute(t,n);if(e.data)for(const[t,n]of Object.entries(e.data))o.setAttribute(`data-${t}`,n);return e.type&&(o.type=e.type),e.title&&(o.title=e.title),e.alt&&(o.alt=e.alt),e.src&&(o.src=e.src),n&&(!Array.isArray(n)&&n instanceof HTMLElement&&(n=[n]),o.append(...n)),o}function n(t={},n=[]){return e("div",t,n)}function o(t={},n=[]){return e("span",t,n)}function i(t={},n=[]){return t.type="button",e("button",t,n)}function s(t={}){return e("img",t)}function c(t,e=24){return o({html:t,class:"x-icon",attributes:{size:e}})}function a(t){return document.querySelector(t)}function r(){return n({class:"thumbnail"})}function d(t,a){const{src:d,alt:l,poster:u,type:h,selected:f}=t,m=n({class:["grid-item",...f?["checked"]:[]],attributes:{"data-src-dw":d,"data-filename":(null==l?void 0:l.length)?l:"","data-item-idx":a,"data-type":h}}),b=i({class:"download_image_button"},c("download")),p=o({class:"item-details"},[o({class:"item-details-ext"}),o({class:"item-details-dimensions"})]);let g=null;"audio"===h?g=function(t){const n=r(),o=c("music_note",50),i=e("audio",{src:t});return i.addEventListener("loadedmetadata",(()=>{const t=function(t){const e=Math.floor(t%60),n=Math.floor(t%3600/60),o=Math.floor(t/3600),i=e<10?`0${e}`:e,s=n<10?`0${n}`:n;return o>0?`${o}:${s}:${i}`:`${s}:${i}`}(i.duration),e=i.closest(".grid-item");null==e||e.setAttribute("duration",t),i.remove()})),n.appendChild(o),n.appendChild(i),n}(d):"image"===h?g=function(t){const e=r(),n=s({src:t});return n.addEventListener("load",(()=>{const t=n.naturalWidth.toString(),e=n.naturalHeight.toString(),o=n.closest("grid-item");null==o||o.setAttribute("original-width",t),null==o||o.setAttribute("original-height",e)})),e.appendChild(n),e}(d):"video"===h&&(g=function(t,n){const o=r(),i=c("videocam",50),a=s({src:n}),d=e("video",{src:t,poster:n});return d.addEventListener("loadedmetadata",(()=>{const t=(e=d.videoWidth)>=3840?"4K":e>=2560?"1440p":e>=1920?"1080p":e>=1280?"720p":e>=854?"480p":e>=640?"360p":"SD";var e;const n=d.closest("grid-item");null==n||n.setAttribute("video-quality",t),d.remove()})),o.appendChild(n?a:i),o.appendChild(d),o}(d,u)),m.appendChild(b),m.appendChild(p),g&&m.appendChild(g);const v=new MutationObserver((t=>{t.forEach((t=>{"attributes"===t.type&&function(t,e,n){const o=t.querySelector(".item-details"),i=o.querySelector(".item-details-dimensions"),s=t.getAttribute("extension"),c=t.getAttribute("duration"),a=t.getAttribute("width"),r=t.getAttribute("height"),d=t.getAttribute("quality");switch(s&&(o.querySelector(".item-details-ext").textContent=s),e){case"audio":i.textContent=c,s&&c&&n.disconnect();break;case"image":i.textContent=`${a} x ${r}`,s&&a&&r&&n.disconnect();break;case"video":i.textContent=d,s&&d&&n.disconnect()}}(m,h,v)}))}));return v.observe(m,{attributes:!0,attributeFilter:["duration","quality","extension","width","height"]}),m}function l(t,c=!1){const{favIconUrl:a,title:r,id:l}=t.tab,u=n({class:["accordion-item",...c?["active"]:[]]});u.setAttribute("tab-id",l);const h=(f=a,m=r,b=t.items.length,n({class:"accordion-header"},i({class:"accordion-button"},[s({src:f,class:"favicon",alt:"Favicon"}),o({class:"tab-title"},[o({class:"title",html:m}),o({class:"tab-media-count",html:b})]),o({class:"tab-toggle"})])));var f,m,b;const p=function(t,i,s){const c=n({class:"accordion-body"});return s?(c.appendChild(n({class:"yt-info"},[o({html:"Note: Chrome Web Store does not allow extensions that download videos from YouTube any longer."}),e("a",{href:"https://developer.chrome.com/docs/webstore/troubleshooting/#prohibited-products",html:"Chrome policy"})])),c.classList.add("restricted")):c.append(...t.map(((t,e)=>d(t,`${i}-${e}`)))),c}(t.items,l,t.tab.isRestricted);return t.showHeader||(h.hidden=!0),u.appendChild(h),u.appendChild(p),u}const u=[],h={};function f(){const t=a(".section-buttons button.selected").getAttribute("data-section")||"images",e=t=>({type:e,selected:n,src:o,poster:i})=>({src:o,poster:i,filetype:e,selected:n,type:t}),n={images:t=>t.images.map(e("image")),videos:t=>t.videos.map(e("video")),audios:t=>t.audios.map(e("audio"))}[t]||(()=>[]);return u.map((({media:t,tab:e})=>({tab:e,items:n(t),showHeader:!0})))}function m(){const t=f();console.log(t),function(t){const e=a(".accordion");e.innerHTML="",t.forEach((t=>{const n=t.tab.id;!function(t,e){t.querySelector(`.accordion-item[tab-id="${e}"]`)}(e,n),e.appendChild(l(t))}))}(t),a(".count-all").innerHTML=function(t){return t.reduce(((t,e)=>t+e.items.length),0)}(t).toString()}function b(t,e){h[t]=e}var p;!function(t){t.TAB_CREATED="tabCreated",t.TAB_REPLACED="tabReplaced",t.TAB_UPDATED="tabUpdated",t.TAB_ACTIVATED="tabActivated",t.SEND_MEDIA="sendMedia"}(p||(p={}));var g=function(t,e,n,o){return new(n||(n=Promise))((function(i,s){function c(t){try{r(o.next(t))}catch(t){s(t)}}function a(t){try{r(o.throw(t))}catch(t){s(t)}}function r(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(c,a)}r((o=o.apply(t,e||[])).next())}))};function v(){return g(this,void 0,void 0,(function*(){var t;let[e]=yield chrome.tabs.query({active:!0,lastFocusedWindow:!0});return(null===(t=null==e?void 0:e.url)||void 0===t?void 0:t.startsWith("chrome://"))?null:e}))}function y(t){!function(t,e=null){const n={url:t};e&&(n.filename=e),chrome.downloads.download(n)}(t.url,t.alt)}const A=["https://youtube.com","https://www.youtube.com"];var w=function(t,e,n,o){return new(n||(n=Promise))((function(i,s){function c(t){try{r(o.next(t))}catch(t){s(t)}}function a(t){try{r(o.throw(t))}catch(t){s(t)}}function r(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(c,a)}r((o=o.apply(t,e||[])).next())}))};const E=["images","audios","videos"];var C;function x(t,e){return w(this,arguments,void 0,(function*(t,e,n=null){var o;n||(n=yield v()),n&&((null===(o=null==n?void 0:n.url)||void 0===o?void 0:o.startsWith("chrome://"))||n.active&&"complete"===e.status&&_())}))}function L(e){const{checked:n}=e.target;let o=!0,i=!0;const s=f();let c=0;t(".grid-item","checked",n);for(let t=0;t<s.length;t++){const{items:e}=s[t];for(let t=0;t<e.length;t++)e[t].selected=n,e[t].selected?(i=!1,c++):o=!1}T(c);const r=a("#toggle_all_checkbox");r.indeterminate=!(o||i),o?r.checked=!0:i&&(r.checked=!1)}function T(t){var e;a("#download-btn .selected-count").innerHTML=t>0?`(${t})`:"",e=!t,a("#download-btn").disabled=e}function _(){!function(){g(this,void 0,void 0,(function*(){const t=yield v();t&&t.id&&(t.id<=0||(yield chrome.scripting.executeScript({target:{tabId:t.id,allFrames:!0},files:["/dist/content-script/send_media.bundle.js"]})))}))}()}C=(t,e,n)=>{const{eventName:o,data:i}=t;switch(console.log(o,i),o){case p.TAB_UPDATED:x(i.tabId,i.changeInfo,i.tab);break;case p.TAB_ACTIVATED:case p.TAB_CREATED:case p.TAB_REPLACED:const{tabId:t,changeInfo:e,tab:n}=i;x(t,e,n);break;case p.SEND_MEDIA:!function(t){w(this,void 0,void 0,(function*(){if(t.error&&Object.keys(t.error).length>0)return void console.log(t);const e=yield v();e&&(E.filter((e=>!!t[e])).forEach((n=>{const o={images:[],videos:[],audios:[]};t[n].filter((t=>!o[n].includes(t)));const i=function(t){return A.some((e=>t.includes(e)))}(e.url);i||t[n].forEach((t=>o[n].push(t)));const{id:s,favIconUrl:c,url:a,title:r}=e,d=u.findIndex((({tab:t})=>t.id===s)),l={id:s,favIconUrl:c,url:a,title:r,isRestricted:i};if(-1===d)u.push({media:o,tab:l});else{const{media:t}=u[d];E.forEach((e=>{var n;u[d].media[e]=(n=[...t[e],...o[e]],[...new Map(n.map((t=>[t.src,t]))).values()]),u[d].tab=l}))}u.forEach((t=>b(t.tab.id,!1))),b(s,!0)})),m())}))}(i)}},chrome.runtime.onMessage.addListener(C),_(),document.body.addEventListener("click",(e=>{const{target:n}=e;if(n)if(n.closest("#download-btn"))!function(t){const e=[];for(let n=0;n<t.length;n++){const{items:o}=t[n];for(let t=0;t<o.length;t++)o[t].selected&&e.push({url:o[t].src,alt:o[t].alt})}e.forEach(y)}(f());else{if(n.closest(".section-buttons button"))return o=n.closest(".section-buttons button").getAttribute("data-section"),o=E.includes(o)?o:"images",t(".section-buttons button","selected",!1),t(`.section-buttons button[data-section="${o}"]`,"selected",!0),void m();var o;if(n.matches(".thumbnail"))!function(e){const n=e.closest(".grid-item"),o=n.getAttribute("data-item-idx"),i=n.getAttribute("data-type"),s=!n.classList.contains("checked");t(n,"checked");const[c,r]=o.split("-").map((t=>+t)),d=function(t){return"image"===t?"images":"video"===t?"videos":"audios"}(i),l=u.findIndex((({tab:t})=>t.id===c));if(-1===l)return;u[l].media[d][r].selected=s;let h=!0,m=!0;const b=f();let p=0;console.log(o,s);for(let t=0;t<b.length;t++){const{items:e}=b[t];for(let t=0;t<e.length;t++)e[t].selected?(m=!1,p++):h=!1}T(p);const g=a("#toggle_all_checkbox");g.indeterminate=!(h||m),h?g.checked=!0:m&&(g.checked=!1)}(n);else if(n.matches(".yt-info a"))window.open("https://developer.chrome.com/docs/webstore/troubleshooting/#prohibited-products");else if(n.matches(".download_image_button")){const t=n.closest(".grid-item"),e=t.getAttribute("data-src-dw"),o=t.getAttribute("data-filename");y({url:e,alt:(null==o?void 0:o.length)?o:null})}else n.closest(".accordion-header")&&t(n.closest(".accordion-header").closest(".accordion-item"),"active")}})),a("#toggle_all_checkbox").addEventListener("change",L)})();