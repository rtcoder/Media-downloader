(()=>{"use strict";function t(t,e,n=null){let o=[];o="string"==typeof t?function(t){const e=[],n=document.querySelectorAll(t);return n.forEach((t=>e.push(t))),n}(t):Array.isArray(t)?[...t]:[t],o.length&&(null===n?[...o].forEach((t=>{t.classList.contains(e)?t.classList.remove(e):t.classList.add(e)})):n?[...o].forEach((t=>t.classList.add(e))):[...o].forEach((t=>t.classList.remove(e))))}function e(t,e={},n=[]){const o=document.createElement(t);if(e.class&&("string"==typeof e.class?o.classList.add(e.class):o.classList.add(...e.class)),e.html&&(o.innerHTML=e.html||""),e.attributes)for(const[t,n]of Object.entries(e.attributes))o.setAttribute(t,n);if(e.data)for(const[t,n]of Object.entries(e.data))o.setAttribute(`data-${t}`,n);return e.type&&(o.type=e.type),e.title&&(o.title=e.title),e.alt&&(o.alt=e.alt),e.src&&(o.src=e.src),n&&(!Array.isArray(n)&&n instanceof HTMLElement&&(n=[n]),o.append(...n)),o}function n(t={},n=[]){return e("div",t,n)}function o(t={},n=[]){return e("span",t,n)}function i(t={},n=[]){return t.type="button",e("button",t,n)}function a(t={}){return e("img",t)}function c(t,e=24){return o({html:t,class:"x-icon",attributes:{size:e}})}function s(t){return document.querySelector(t)}const r=(()=>{let t;const e=[];for(let n=0;n<256;n++){t=n;for(let e=0;e<8;e++)t=1&t?3988292384^t>>>1:t>>>1;e[n]=t}return e})();function l(){return n({class:"thumbnail"})}function d(t,s){const{src:r,alt:d,poster:u,type:h,selected:f}=t,m=n({class:["grid-item",...f?["checked"]:[]],attributes:{"data-src-dw":r,"data-filename":(null==d?void 0:d.length)?d:"","data-item-idx":s,"data-type":h}}),b=i({class:"download_image_button"},c("download")),p=o({class:"item-details"},[o({class:"item-details-ext"}),o({class:"item-details-dimensions"})]);let g=null;"audio"===h?g=function(t){const n=l(),o=c("music_note",50),i=e("audio",{src:t});return i.addEventListener("loadedmetadata",(()=>{const t=function(t){const e=Math.floor(t%60),n=Math.floor(t%3600/60),o=Math.floor(t/3600),i=e<10?`0${e}`:e,a=n<10?`0${n}`:n;return o>0?`${o}:${a}:${i}`:`${a}:${i}`}(i.duration),e=i.closest(".grid-item");null==e||e.setAttribute("duration",t),i.remove()})),n.appendChild(o),n.appendChild(i),n}(r):"image"===h?g=function(t){const e=l(),n=a({src:t});return n.addEventListener("load",(()=>{const t=n.naturalWidth.toString(),e=n.naturalHeight.toString(),o=n.closest("grid-item");null==o||o.setAttribute("original-width",t),null==o||o.setAttribute("original-height",e)})),e.appendChild(n),e}(r):"video"===h&&(g=function(t,n){const o=l(),i=c("videocam",50),s=a({src:n}),r=e("video",{src:t,poster:n});return r.addEventListener("loadedmetadata",(()=>{const t=(e=r.videoWidth)>=3840?"4K":e>=2560?"1440p":e>=1920?"1080p":e>=1280?"720p":e>=854?"480p":e>=640?"360p":"SD";var e;const n=r.closest("grid-item");null==n||n.setAttribute("video-quality",t),r.remove()})),o.appendChild(n?s:i),o.appendChild(r),o}(r,u)),m.appendChild(b),m.appendChild(p),g&&m.appendChild(g);const v=new MutationObserver((t=>{t.forEach((t=>{"attributes"===t.type&&function(t,e,n){const o=t.querySelector(".item-details"),i=o.querySelector(".item-details-dimensions"),a=t.getAttribute("extension"),c=t.getAttribute("duration"),s=t.getAttribute("width"),r=t.getAttribute("height"),l=t.getAttribute("quality");switch(a&&(o.querySelector(".item-details-ext").textContent=a),e){case"audio":i.textContent=c,a&&c&&n.disconnect();break;case"image":i.textContent=`${s} x ${r}`,a&&s&&r&&n.disconnect();break;case"video":i.textContent=l,a&&l&&n.disconnect()}}(m,h,v)}))}));return v.observe(m,{attributes:!0,attributeFilter:["duration","quality","extension","width","height"]}),m}function u(t,c){const{title:s,uuid:r,id:l}=t.tab,u=n({class:["accordion-item",...f[r]?["active"]:[]]});u.setAttribute("tab-uuid",r);const h=(m=c,b=s,p=t.items.length,n({class:"accordion-header"},i({class:"accordion-button"},[a({src:m,class:"favicon",alt:"Favicon"}),o({class:"tab-title"},[o({class:"title",html:b}),o({class:"tab-media-count",html:p})]),o({class:"tab-toggle"})])));var m,b,p;const g=function(t,i,a,c){const s=n({class:"accordion-body"});return c?(s.appendChild(n({class:"yt-info"},[o({html:"Note: Chrome Web Store does not allow extensions that download videos from YouTube any longer."}),e("a",{href:"https://developer.chrome.com/docs/webstore/troubleshooting/#prohibited-products",html:"Chrome policy"})])),s.classList.add("restricted")):s.append(...t.map(((t,e)=>d(t,`${i}-${a}-${e}`)))),s}(t.items,l,r,t.tab.isRestricted);return u.appendChild(h),u.appendChild(g),u}const h=[],f={};function m(){const t=s(".section-buttons button.selected").getAttribute("data-section")||"image",e=t=>({type:e,selected:n,src:o,poster:i})=>({src:o,poster:i,filetype:e,selected:n,type:t}),n={image:t=>t.image.map(e("image")),video:t=>t.video.map(e("video")),audio:t=>t.audio.map(e("audio"))}[t]||(()=>[]);return h.map((t=>{const e=t.elements.map((({media:t,tab:e})=>({tab:e,items:n(t)})));return{tabId:t.tabId,tabFavicon:t.tabFavicon,data:e}}))}function b(){const t=m();console.log(t),function(t){const e=s(".accordion");e.innerHTML="",t.forEach((t=>{e.appendChild(function(t){const e=n({class:"accordion-group",attributes:{"data-tab-subgroup":t.tabId}});return t.data.forEach((n=>{e.appendChild(u(n,t.tabFavicon))})),e}(t))}))}(t),s(".count-all").innerHTML=function(t){return t.reduce(((t,e)=>t+e.data.reduce(((t,e)=>t+e.items.length),0)),0)}(t).toString()}function p(t,e){f[t]=e}var g;!function(t){t.TAB_CREATED="tabCreated",t.TAB_REPLACED="tabReplaced",t.TAB_UPDATED="tabUpdated",t.TAB_ACTIVATED="tabActivated",t.SEND_MEDIA="sendMedia"}(g||(g={}));var v=function(t,e,n,o){return new(n||(n=Promise))((function(i,a){function c(t){try{r(o.next(t))}catch(t){a(t)}}function s(t){try{r(o.throw(t))}catch(t){a(t)}}function r(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(c,s)}r((o=o.apply(t,e||[])).next())}))};function y(){return v(this,void 0,void 0,(function*(){var t;let[e]=yield chrome.tabs.query({active:!0,lastFocusedWindow:!0});return(null===(t=null==e?void 0:e.url)||void 0===t?void 0:t.startsWith("chrome://"))?null:e}))}function A(t){!function(t,e=null){const n={url:t};e&&(n.filename=e),chrome.downloads.download(n)}(t.url,t.alt)}const E=["https://youtube.com","https://www.youtube.com"];var w=function(t,e,n,o){return new(n||(n=Promise))((function(i,a){function c(t){try{r(o.next(t))}catch(t){a(t)}}function s(t){try{r(o.throw(t))}catch(t){a(t)}}function r(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(c,s)}r((o=o.apply(t,e||[])).next())}))};const C=["image","audio","video"];var x;function I(t,e){return w(this,arguments,void 0,(function*(t,e,n=null){var o;n||(n=yield y()),n&&((null===(o=null==n?void 0:n.url)||void 0===o?void 0:o.startsWith("chrome://"))||n.active&&"complete"===e.status&&_())}))}function L(e){const{checked:n}=e.target;let o=!0,i=!0;const a=m();let c=0;t(".grid-item","checked",n);for(let t=0;t<a.length;t++){const{data:e}=a[t];for(let t=0;t<e.length;t++){const{items:a}=e[t];for(let t=0;t<a.length;t++)a[t].selected=n,a[t].selected?(i=!1,c++):o=!1}}T(c);const r=s("#toggle_all_checkbox");r.indeterminate=!(o||i),o?r.checked=!0:i&&(r.checked=!1)}function T(t){var e;s("#download-btn .selected-count").innerHTML=t>0?`(${t})`:"",e=!t,s("#download-btn").disabled=e}function _(){!function(){v(this,void 0,void 0,(function*(){const t=yield y();t&&t.id&&(t.id<=0||(yield chrome.scripting.executeScript({target:{tabId:t.id,allFrames:!0},files:["/dist/content-script/send_media.bundle.js"]})))}))}()}x=t=>{const{eventName:e,data:n}=t;switch(console.log(e,n),e){case g.TAB_UPDATED:I(n.tabId,n.changeInfo,n.tab);break;case g.TAB_ACTIVATED:case g.TAB_CREATED:case g.TAB_REPLACED:const{tabId:t,changeInfo:e,tab:o}=n;I(t,e,o);break;case g.SEND_MEDIA:!function(t){w(this,void 0,void 0,(function*(){if(t.error&&Object.keys(t.error).length>0)return void console.log(t);const e=yield y();e&&(C.filter((e=>!!t[e])).forEach((n=>{const o={image:[],video:[],audio:[]};t[n].filter((t=>!o[n].includes(t)));const i=(a=e.url,E.some((t=>a.includes(t))));var a;i||t[n].forEach((t=>o[n].push(t)));const c=function(t){let e=-1;for(let n=0;n<t.length;n++)e=e>>>8^r[255&(e^t.charCodeAt(n))];return~e>>>0}(`${e.id}-${e.url}`.toString()).toString(16).padStart(8,"0");let s=h.findIndex((({tabId:t})=>t===e.id));-1===s&&(h.push({tabId:e.id,tabFavicon:e.favIconUrl,elements:[]}),s=h.length-1);const l=h[s].elements.findIndex((({tab:t})=>t.uuid===c)),d={id:e.id,favIconUrl:e.favIconUrl,url:e.url,title:e.title,isRestricted:i,uuid:c};if(-1===l)h[s].elements.push({media:o,tab:d});else{const{media:t}=h[s].elements[l];C.forEach((e=>{var n;h[s].elements[l].media[e]=(n=[...t[e],...o[e]],[...new Map(n.map((t=>[t.src,t]))).values()]),h[s].elements[l].tab=d}))}h.forEach((t=>{t.elements.forEach((t=>p(t.tab.uuid,!1)))})),p(c,!0)})),b())}))}(n)}},chrome.runtime.onMessage.addListener(x),_(),document.body.addEventListener("click",(e=>{const{target:n}=e;if(n)if(n.closest("#download-btn"))!function(t){const e=[];for(let n=0;n<t.length;n++){const{data:o}=t[n];for(let t=0;t<o.length;t++){const{items:n}=o[t];for(let t=0;t<n.length;t++)n[t].selected&&e.push({url:n[t].src,alt:n[t].alt})}}e.forEach(A)}(m());else{if(n.closest(".section-buttons button"))return o=n.closest(".section-buttons button").getAttribute("data-section"),o=C.includes(o)?o:"image",t(".section-buttons button","selected",!1),t(`.section-buttons button[data-section="${o}"]`,"selected",!0),void b();var o;if(n.matches(".thumbnail"))!function(e){const n=e.closest(".grid-item"),o=n.getAttribute("data-item-idx"),i=n.getAttribute("data-type"),a=!n.classList.contains("checked");t(n,"checked");const[c,r,l]=o.split("-"),d=function(t){return"image"===t?"image":"video"===t?"video":"audio"}(i),u=h.findIndex((({tabId:t})=>t===+c)),f=h[u].elements.findIndex((({tab:t})=>t.uuid===r));if(-1===f)return;h[u].elements[f].media[d][+l].selected=a;let b=!0,p=!0;const g=m();let v=0;console.log(o,a);for(let t=0;t<g.length;t++){const{data:e}=g[t];for(let t=0;t<e.length;t++){const{items:n}=e[t];for(let t=0;t<n.length;t++)n[t].selected?(p=!1,v++):b=!1}}T(v);const y=s("#toggle_all_checkbox");y.indeterminate=!(b||p),b?y.checked=!0:p&&(y.checked=!1)}(n);else if(n.matches(".yt-info a"))window.open("https://developer.chrome.com/docs/webstore/troubleshooting/#prohibited-products");else if(n.matches(".download_image_button")){const t=n.closest(".grid-item"),e=t.getAttribute("data-src-dw"),o=t.getAttribute("data-filename");A({url:e,alt:(null==o?void 0:o.length)?o:null})}else n.closest(".accordion-header")&&t(n.closest(".accordion-header").closest(".accordion-item"),"active")}})),s("#toggle_all_checkbox").addEventListener("change",L)})();