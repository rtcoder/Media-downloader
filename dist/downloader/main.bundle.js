(()=>{"use strict";function t(t,e,n=null){const i=function(t){const e=[],n=document.querySelectorAll(t);return n.forEach((t=>e.push(t))),n}(t);i&&(null===n?[...i].forEach((t=>{t.classList.contains(e)?t.classList.remove(e):t.classList.add(e)})):n?[...i].forEach((t=>t.classList.add(e))):[...i].forEach((t=>t.classList.remove(e))))}function e(t,e={},n=[]){const i=document.createElement(t);if(e.class&&("string"==typeof e.class?i.classList.add(e.class):i.classList.add(...e.class)),e.html&&(i.innerHTML=e.html||""),e.attributes)for(const[t,n]of Object.entries(e.attributes))i.setAttribute(t,n);if(e.data)for(const[t,n]of Object.entries(e.data))i.setAttribute(`data-${t}`,n);return e.type&&(i.type=e.type),e.title&&(i.title=e.title),e.alt&&(i.alt=e.alt),e.src&&(i.src=e.src),n&&(!Array.isArray(n)&&n instanceof HTMLElement&&(n=[n]),i.append(...n)),i}function n(t={},n=[]){return e("div",t,n)}function i(t={},n=[]){return e("span",t,n)}function o(t={},n=[]){return t.type="button",e("button",t,n)}function c(t={}){return e("img",t)}function s(t,e=24){return i({html:t,class:"x-icon",attributes:{size:e}})}function a(t){return document.querySelector(t)}var r=function(t,e,n,i){return new(n||(n=Promise))((function(o,c){function s(t){try{r(i.next(t))}catch(t){c(t)}}function a(t){try{r(i.throw(t))}catch(t){c(t)}}function r(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}r((i=i.apply(t,e||[])).next())}))};function d(){return r(this,void 0,void 0,(function*(){var t;let[e]=yield chrome.tabs.query({active:!0,lastFocusedWindow:!0});return(null===(t=null==e?void 0:e.url)||void 0===t?void 0:t.startsWith("chrome://"))?null:e}))}function l(t){!function(t,e=null){const n={url:t};e&&(n.filename=e),chrome.downloads.download(n)}(t.url,t.alt)}function u(t,e,n,i=!0,o=!0){t.dispatchEvent(new CustomEvent(e,{detail:n,bubbles:i,composed:o}))}function f(){return n({class:"thumbnail"})}function h(t,a){const{src:r,alt:d,poster:h,type:m,selected:b}=t,p=n({class:["grid-item",...b?["checked"]:[]]});p.setAttribute("item-idx",a);const v=o({class:"download_image_button"},s("download"));v.addEventListener("click",(()=>{l({url:r,alt:(null==d?void 0:d.length)?d:null})}));const g=i({class:"item-details"},[i({class:"item-details-ext"}),i({class:"item-details-dimensions"})]);let y=null;"audio"===m?y=function(t){const n=f(),i=s("music_note",50),o=e("audio",{src:t});return o.addEventListener("loadedmetadata",(()=>{const t=function(t){const e=Math.floor(t%60),n=Math.floor(t%3600/60),i=Math.floor(t/3600),o=e<10?`0${e}`:e,c=n<10?`0${n}`:n;return i>0?`${i}:${c}:${o}`:`${c}:${o}`}(o.duration),e=o.closest(".grid-item");null==e||e.setAttribute("duration",t),o.remove()})),n.appendChild(i),n.appendChild(o),n}(r):"image"===m?y=function(t){const e=f(),n=c({src:t});return n.addEventListener("load",(()=>{const t=n.naturalWidth.toString(),e=n.naturalHeight.toString(),i=n.closest("grid-item");null==i||i.setAttribute("original-width",t),null==i||i.setAttribute("original-height",e)})),e.appendChild(n),e}(r):"video"===m&&(y=function(t,n){const i=f(),o=e("video",{src:t,poster:n});return o.addEventListener("loadedmetadata",(()=>{const t=(e=o.videoWidth)>=3840?"4K":e>=2560?"1440p":e>=1920?"1080p":e>=1280?"720p":e>=854?"480p":e>=640?"360p":"SD";var e;const n=o.closest("grid-item");null==n||n.setAttribute("video-quality",t)})),i.appendChild(o),i}(r,h)),p.appendChild(v),p.appendChild(g),y&&(y.addEventListener("click",(()=>{const t=p.classList.contains("checked");u(document,"thumbnail-clicked",{itemIndex:a,value:!t,type:m})})),p.appendChild(y));const E=new MutationObserver((t=>{t.forEach((t=>{"attributes"===t.type&&function(t,e,n){const i=t.querySelector(".item-details"),o=i.querySelector(".item-details-dimensions"),c=t.getAttribute("extension"),s=t.getAttribute("duration"),a=t.getAttribute("width"),r=t.getAttribute("height"),d=t.getAttribute("quality");switch(c&&(i.querySelector(".item-details-ext").textContent=c),e){case"audio":o.textContent=s,c&&s&&n.disconnect();break;case"image":o.textContent=`${a} x ${r}`,c&&a&&r&&n.disconnect();break;case"video":o.textContent=d,c&&d&&n.disconnect()}}(p,m,E)}))}));return E.observe(p,{attributes:!0,attributeFilter:["duration","quality","extension","width","height"]}),p}const m=[],b={};function p(){const t=a(".section-buttons button.selected").getAttribute("data-section")||"images",e=t=>({type:e,selected:n,src:i,poster:o})=>({src:i,poster:o,filetype:e,selected:n,type:t}),n={images:t=>t.images.map(e("image")),videos:t=>t.videos.map(e("video")),audios:t=>t.audios.map(e("audio"))}[t]||(()=>[]);return m.map((({media:t,tab:e})=>({tab:e,items:n(t),showHeader:!0})))}function v(){const t=p();console.log(t),function(t){const e=a(".accordion");t.forEach((t=>{const s=t.tab.id,a=function(t,e){return t.querySelector(`.accordion-item[tab-id="${e}"]`)}(e,s);a?t.items.forEach(((t,e)=>{const n=`${s}-${e}`,i=function(t,e){return t.querySelector(`.grid-item[item-idx="${e}"]`)}(a,n);i||a.querySelector(".accordion-body").appendChild(h(t,n))})):e.appendChild(function(t,e=!1){const{favIconUrl:s,title:a,id:r}=t.tab,d=n({class:"accordion-item"});d.setAttribute("tab-id",r);const l=(f=s,m=a,b=t.items.length,n({class:["accordion-header","active"]},o({class:"accordion-button"},[c({src:f,class:"favicon",alt:"Favicon"}),i({class:"tab-title"},[i({class:"title",html:m}),i({class:"tab-media-count",html:b})]),i({class:"tab-toggle"})]))),u=function(t,e,i){return n({class:"accordion-body",hidden:!i},t.map(((t,n)=>h(t,`${e}-${n}`))))}(t.items,r,e);var f,m,b;return t.showHeader||(l.hidden=!0),d.appendChild(l),d.appendChild(u),d}(t))}))}(t),a(".count-all").innerHTML=function(t){return t.reduce(((t,e)=>t+e.items.length),0)}(t).toString()}function g(t,e){b[t]=e}var y;!function(t){t.TAB_CREATED="tabCreated",t.TAB_REPLACED="tabReplaced",t.TAB_UPDATED="tabUpdated",t.TAB_ACTIVATED="tabActivated",t.SEND_MEDIA="sendMedia"}(y||(y={}));var E=function(t,e,n,i){return new(n||(n=Promise))((function(o,c){function s(t){try{r(i.next(t))}catch(t){c(t)}}function a(t){try{r(i.throw(t))}catch(t){c(t)}}function r(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}r((i=i.apply(t,e||[])).next())}))};const A=["images","audios","videos"],w=["https://youtube.com","https://www.youtube.com"];var L;function x(t,e){return E(this,arguments,void 0,(function*(t,e,n=null){var i;n||(n=yield d()),n&&((null===(i=null==n?void 0:n.url)||void 0===i?void 0:i.startsWith("chrome://"))||n.active&&"complete"===e.status&&$())}))}function C(t){const{checked:e}=t.target;u(document,"select-all",{value:e})}function T(t){const{itemIndex:e,value:n,type:i}=t.detail,[o,c]=e.split("-").map((t=>+t)),s=function(t){return"image"===t?"images":"video"===t?"videos":"audios"}(i),r=m.findIndex((({tab:t})=>t.id===o));if(-1===r)return;m[r].media[s][c].selected=n;let d=!0,l=!0;const u=p();let f=0;console.log(e,n);for(let t=0;t<u.length;t++){const{items:e}=u[t];for(let t=0;t<e.length;t++)e[t].selected?(l=!1,f++):d=!1}!function(t){a("#download-btn .selected-count").innerHTML=t>0?`(${t})`:"",function(t,e){a("#download-btn").disabled=e}(0,!t)}(f);const h=a("#toggle_all_checkbox");h.indeterminate=!(d||l),d?h.checked=!0:l&&(h.checked=!1)}function $(){!function(){r(this,void 0,void 0,(function*(){const t=yield d();t&&t.id&&(t.id<=0||(yield chrome.scripting.executeScript({target:{tabId:t.id,allFrames:!0},files:["/dist/content-script/send_media.bundles.js"]})))}))}()}L=(t,e,n)=>{const{eventName:i,data:o}=t;switch(console.log(i,o),i){case y.TAB_UPDATED:x(o.tabId,o.changeInfo,o.tab);break;case y.TAB_ACTIVATED:case y.TAB_CREATED:case y.TAB_REPLACED:const{tabId:t,changeInfo:e,tab:n}=o;x(t,e,n);break;case y.SEND_MEDIA:!function(t){E(this,void 0,void 0,(function*(){if(t.error&&Object.keys(t.error).length>0)return void console.log(t);const e=yield d();var n;e&&(function(){const t=a(".yt-info");t&&(t.hidden=!0)}(),n=e.url,w.some((t=>n.includes(t)))?function(){const t=a(".yt-info");t&&(t.hidden=!1)}():(A.filter((e=>!!t[e])).forEach((n=>{const i={images:[],videos:[],audios:[]};t[n].filter((t=>!i[n].includes(t))).forEach((t=>i[n].push(t)));const{id:o,favIconUrl:c,url:s,title:a}=e,r=m.findIndex((({tab:t})=>t.id===o)),d={id:o,favIconUrl:c,url:s,title:a};if(-1===r)m.push({media:i,tab:d});else{const{media:t}=m[r];A.forEach((e=>{var n;m[r].media[e]=(n=[...t[e],...i[e]],[...new Map(n.map((t=>[t.src,t]))).values()]),m[r].tab=d}))}m.forEach((t=>g(t.tab.id,!1))),g(o,!0)})),v()))}))}(o)}},chrome.runtime.onMessage.addListener(L),$(),document.body.addEventListener("click",(e=>{const{target:n}=e;if(n)if(n.closest("#download-btn"))!function(t){const e=[];for(let n=0;n<t.length;n++){const{items:i}=t[n];for(let t=0;t<i.length;t++)i[t].selected&&e.push({url:i[t].src,alt:i[t].alt})}e.forEach(l)}(p());else{if(n.closest(".section-buttons button"))return i=n.closest(".section-buttons button").getAttribute("data-section"),i=A.includes(i)?i:"images",t(".section-buttons button","selected",!1),t(`.section-buttons button[data-section="${i}"]`,"selected",!0),void v();var i;n.matches(".thumbnail")?T(e):n.matches(".accordion-header")||n.closest(".accordion-button")?n.closest(".accordion-item").classList.toggle("active"):n.matches(".yt-info a")&&window.open("https://developer.chrome.com/docs/webstore/troubleshooting/#prohibited-products")}})),document.addEventListener("thumbnail-clicked",T),a("#toggle_all_checkbox").addEventListener("change",C)})();