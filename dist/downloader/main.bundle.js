(()=>{"use strict";var t=function(t,e,n,o){return new(n||(n=Promise))((function(i,c){function s(t){try{r(o.next(t))}catch(t){c(t)}}function a(t){try{r(o.throw(t))}catch(t){c(t)}}function r(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}r((o=o.apply(t,e||[])).next())}))};function e(){return t(this,void 0,void 0,(function*(){var t,e;try{let n={active:!0,lastFocusedWindow:!0},[o]=yield chrome.tabs.query(n);return console.log("current tabUrl: ",null==o?void 0:o.url,o),!(null==o?void 0:o.url)||(null===(t=null==o?void 0:o.url)||void 0===t?void 0:t.startsWith("chrome://"))||(null===(e=null==o?void 0:o.url)||void 0===e?void 0:e.startsWith("https://chromewebstore.google.com"))?null:o}catch(t){return null}}))}function n(e){return t(this,void 0,void 0,(function*(){var t,n;try{const o=yield chrome.tabs.get(e);return chrome.runtime.lastError?(console.error("Error get tab by ID:",chrome.runtime.lastError),null):(console.log("tabUrl: ",null==o?void 0:o.url),!(null==o?void 0:o.url)||(null===(t=null==o?void 0:o.url)||void 0===t?void 0:t.startsWith("chrome://"))||(null===(n=null==o?void 0:o.url)||void 0===n?void 0:n.startsWith("https://chromewebstore.google.com"))?null:o)}catch(t){return null}}))}function o(t,e,n=null){let o=[];o="string"==typeof t?function(t){const e=[],n=document.querySelectorAll(t);return n.forEach((t=>e.push(t))),n}(t):Array.isArray(t)?[...t]:[t],o.length&&(null===n?[...o].forEach((t=>{t.classList.contains(e)?t.classList.remove(e):t.classList.add(e)})):n?[...o].forEach((t=>t.classList.add(e))):[...o].forEach((t=>t.classList.remove(e))))}function i(t,e={},n=[]){const o=document.createElement(t);if(e.class&&("string"==typeof e.class?o.classList.add(e.class):o.classList.add(...e.class)),e.html&&(o.innerHTML=e.html||""),e.attributes)for(const[t,n]of Object.entries(e.attributes))o.setAttribute(t,n);if(e.data)for(const[t,n]of Object.entries(e.data))o.setAttribute(`data-${t}`,n);return e.type&&(o.type=e.type),e.title&&(o.title=e.title),e.alt&&(o.alt=e.alt),e.src&&(o.src=e.src),n&&(!Array.isArray(n)&&n instanceof HTMLElement&&(n=[n]),o.append(...n)),o}function c(t={},e=[]){return i("div",t,e)}function s(t={},e=[]){return i("span",t,e)}function a(t={},e=[]){return t.type="button",i("button",t,e)}function r(t={}){return i("img",t)}function l(t,e=24){return s({html:t,class:"x-icon",attributes:{size:e}})}function d(t){return document.querySelector(t)}const u=(()=>{let t;const e=[];for(let n=0;n<256;n++){t=n;for(let e=0;e<8;e++)t=1&t?3988292384^t>>>1:t>>>1;e[n]=t}return e})();function h(){return c({class:"thumbnail"})}function f(t,e){const{src:n,alt:o,poster:d,type:u,selected:f}=t,m=c({class:["grid-item",...f?["checked"]:[]],attributes:{"data-src-dw":n,"data-filename":(null==o?void 0:o.length)?o:"","data-item-idx":e,"data-type":u}}),b=a({class:"download_image_button"},l("download")),g=i("a",{attributes:{href:t.src,download:t.alt||""}},b),p=s({class:"item-details"},[s({class:"item-details-ext"}),s({class:"item-details-dimensions"})]);let v=null;"audio"===u?v=function(t){const e=h(),n=l("music_note",50),o=i("audio",{src:t});return o.addEventListener("loadedmetadata",(()=>{const t=function(t){const e=Math.floor(t%60),n=Math.floor(t%3600/60),o=Math.floor(t/3600),i=e<10?`0${e}`:e,c=n<10?`0${n}`:n;return o>0?`${o}:${c}:${i}`:`${c}:${i}`}(o.duration),e=o.closest(".grid-item");null==e||e.setAttribute("duration",t),o.remove()})),e.appendChild(n),e.appendChild(o),e}(n):"image"===u?v=function(t){const e=h(),n=r({src:t});return n.addEventListener("load",(()=>{const t=n.naturalWidth.toString(),e=n.naturalHeight.toString(),o=n.closest("grid-item");null==o||o.setAttribute("original-width",t),null==o||o.setAttribute("original-height",e)})),e.appendChild(n),e}(n):"video"===u&&(v=function(t,e){const n=h(),o=l("videocam",50),c=r({src:e}),s=i("video",{src:t,poster:e});return s.addEventListener("loadedmetadata",(()=>{const t=(e=s.videoWidth)>=3840?"4K":e>=2560?"1440p":e>=1920?"1080p":e>=1280?"720p":e>=854?"480p":e>=640?"360p":"SD";var e;const n=s.closest("grid-item");null==n||n.setAttribute("video-quality",t),s.remove()})),n.appendChild(e?c:o),n.appendChild(s),n}(n,d)),m.appendChild(g),m.appendChild(p),v&&m.appendChild(v);const y=new MutationObserver((t=>{t.forEach((t=>{"attributes"===t.type&&function(t,e,n){const o=t.querySelector(".item-details"),i=o.querySelector(".item-details-dimensions"),c=t.getAttribute("extension"),s=t.getAttribute("duration"),a=t.getAttribute("width"),r=t.getAttribute("height"),l=t.getAttribute("quality");switch(c&&(o.querySelector(".item-details-ext").textContent=c),e){case"audio":i.textContent=s,c&&s&&n.disconnect();break;case"image":i.textContent=`${a} x ${r}`,c&&a&&r&&n.disconnect();break;case"video":i.textContent=l,c&&l&&n.disconnect()}}(m,u,y)}))}));return y.observe(m,{attributes:!0,attributeFilter:["duration","quality","extension","width","height"]}),m}function m(t){const{title:e,uuid:n,id:o,favIconUrl:l}=t.tab,d=c({class:["accordion-item",...g[n]?["active"]:[]]});d.setAttribute("tab-uuid",n);const u=(h=l,m=e,b=t.items.length,c({class:"accordion-header"},a({class:"accordion-button"},[r({src:h,class:"favicon",alt:"Favicon"}),s({class:"tab-title"},[s({class:"title",html:m}),s({class:"tab-media-count",html:`(${b})`})]),s({class:"tab-toggle"})])));var h,m,b;const p=function(t,e,n,o){const a=c({class:"accordion-body"});return o?(a.appendChild(c({class:"yt-info"},[s({html:"Note: Chrome Web Store does not allow extensions that download videos from YouTube any longer."}),i("a",{href:"https://developer.chrome.com/docs/webstore/troubleshooting/#prohibited-products",html:"Chrome policy"})])),a.classList.add("restricted")):a.append(...t.map((t=>f(t,`${e}-${n}-${t.uuid}`)))),a}(t.items,o,n,t.tab.isRestricted);return d.appendChild(u),d.appendChild(p),d}const b=[],g={};function p(){const t=d(".section-buttons button.selected").getAttribute("data-section")||"image";return b.map((e=>{const n=e.elements.map((({media:e,tab:n})=>{const o=(e=>e[t].map((e=>function(t,e){const{src:n,uuid:o,poster:i,type:c,selected:s,alt:a}=t;return{src:n,uuid:o,poster:i,filetype:c,selected:s,type:e,alt:a}}(e,t))))(e);return{tab:n,items:o}}));return{tabId:e.tabId,data:n}}))}function v(){const t=p();console.log(t),function(t){const e=d(".accordion");e.innerHTML="",t.forEach((t=>{e.appendChild(function(t){const e=c({class:"accordion-group",attributes:{"data-tab-subgroup":t.tabId}});return t.data.forEach((t=>{e.appendChild(m(t))})),e}(t))}))}(t),d(".count-all").innerHTML=function(t){return t.reduce(((t,e)=>t+e.data.reduce(((t,e)=>t+e.items.length),0)),0)}(t).toString()}function y(t,e){g[t]=e}function A(t){!function(t,e=null){const n={url:t};e&&(n.filename=e),chrome.downloads.download(n)}(t.url,t.alt)}const E=["image","audio","video"];function w(t){const{checked:e}=t.target;let n=!0,i=!0;const c=p();let s=0;o(".grid-item","checked",e);for(let t=0;t<c.length;t++){const{data:o}=c[t];for(let t=0;t<o.length;t++){const{items:c}=o[t];for(let t=0;t<c.length;t++)c[t].selected=e,c[t].selected?(i=!1,s++):n=!1}}C(s);const a=d("#toggle_all_checkbox");a.indeterminate=!(n||i),n?a.checked=!0:i&&(a.checked=!1)}function C(t){var e;d("#download-btn .selected-count").innerHTML=t>0?`(${t})`:"",e=!t,d("#download-btn").disabled=e}function k(){!function(){t(this,void 0,void 0,(function*(){const t=yield e();t&&t.id&&(t.id<=0||(yield chrome.scripting.executeScript({target:{tabId:t.id,allFrames:!0},files:["/dist/content-script/send_media.bundle.js"]})))}))}()}var x;!function(t){t.TAB_CREATED="tabCreated",t.TAB_REPLACED="tabReplaced",t.TAB_UPDATED="tabUpdated",t.TAB_ACTIVATED="tabActivated",t.SEND_MEDIA="sendMedia"}(x||(x={}));const L=["https://youtube.com","https://www.youtube.com"];var I,T,_=function(t,e,n,o){return new(n||(n=Promise))((function(i,c){function s(t){try{r(o.next(t))}catch(t){c(t)}}function a(t){try{r(o.throw(t))}catch(t){c(t)}}function r(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}r((o=o.apply(t,e||[])).next())}))};function $(t){return _(this,void 0,void 0,(function*(){if(t.error&&Object.keys(t.error).length>0)return void console.log(t);const n=yield e();n&&(E.filter((e=>!!t[e])).forEach((e=>{const o={image:[],video:[],audio:[]};t[e].filter((t=>!o[e].includes(t)));const i=(c=n.url,L.some((t=>c.includes(t))));var c;i||t[e].forEach((t=>o[e].push(t)));const s=function(t){let e=-1;for(let n=0;n<t.length;n++)e=e>>>8^u[255&(e^t.charCodeAt(n))];return~e>>>0}(`${n.id}-${n.url}`.toString()).toString(16).padStart(8,"0");let a=b.findIndex((({tabId:t})=>t===n.id));-1===a&&(b.push({tabId:n.id,elements:[]}),a=b.length-1);const r=b[a].elements.findIndex((({tab:t})=>t.uuid===s)),l={id:n.id,favIconUrl:n.favIconUrl,url:n.url,title:n.title,isRestricted:i,uuid:s};if(-1===r)b[a].elements.push({media:o,tab:l});else{const{media:t}=b[a].elements[r];E.forEach((e=>{var n;b[a].elements[r].media[e]=(n=[...t[e],...o[e]],[...new Map(n.map((t=>[t.src,t]))).values()]),b[a].elements[r].tab=l}))}b.forEach((t=>{t.elements.forEach((t=>y(t.tab.uuid,!1)))})),y(s,!0)})),v())}))}k(),function(){var t;t=t=>{const{eventName:e,data:o}=t;switch(console.log(e,o),e){case x.TAB_UPDATED:o.tabId,i=o.changeInfo,o.tab.active&&"complete"===i.status&&k();break;case x.TAB_ACTIVATED:!function(t){_(this,void 0,void 0,(function*(){const e=yield n(t);e&&e.active&&k()}))}(o.tabId);break;case x.TAB_CREATED:o.tab.active&&k();break;case x.TAB_REPLACED:!function(t){_(this,void 0,void 0,(function*(){const e=yield n(t);e&&e.active&&k()}))}(o.tabId);break;case x.SEND_MEDIA:$(o)}var i},chrome.runtime.onMessage.addListener(t)}(),document.body.addEventListener("click",(t=>{const{target:e}=t;if(e)if(e.closest("#download-btn"))!function(t){const e=[];for(let n=0;n<t.length;n++){const{data:o}=t[n];for(let t=0;t<o.length;t++){const{items:n}=o[t];for(let t=0;t<n.length;t++)n[t].selected&&e.push({url:n[t].src,alt:n[t].alt})}}e.forEach(A)}(p());else{if(e.closest(".section-buttons button"))return n=e.closest(".section-buttons button").getAttribute("data-section"),n=E.includes(n)?n:"image",o(".section-buttons button","selected",!1),o(`.section-buttons button[data-section="${n}"]`,"selected",!0),void v();var n;if(e.matches(".thumbnail"))!function(t){const e=t.closest(".grid-item"),n=e.getAttribute("data-item-idx"),i=e.getAttribute("data-type"),c=!e.classList.contains("checked");o(e,"checked");const[s,a,r]=n.split("-"),l=function(t){return"image"===t?"image":"video"===t?"video":"audio"}(i),u=b.findIndex((({tabId:t})=>t===+s)),h=b[u].elements.findIndex((({tab:t})=>t.uuid===a));if(-1===h)return;b[u].elements[h].media[l][+r].selected=c;let f=!0,m=!0;const g=p();let v=0;console.log(n,c);for(let t=0;t<g.length;t++){const{data:e}=g[t];for(let t=0;t<e.length;t++){const{items:n}=e[t];for(let t=0;t<n.length;t++)n[t].selected?(m=!1,v++):f=!1}}C(v);const y=d("#toggle_all_checkbox");y.indeterminate=!(f||m),f?y.checked=!0:m&&(y.checked=!1)}(e);else if(e.matches(".yt-info a"))window.open("https://developer.chrome.com/docs/webstore/troubleshooting/#prohibited-products");else{if(e.matches(".changelog-link"))return c={showChangelogLink:!1},chrome.storage.sync.set(c),i={url:"views/changelog.html"},chrome.tabs.create(i),void function(t){const e="string"==typeof t?d(t):t;e&&(e.hidden=!0)}(e);var i,c;e.closest(".accordion-header")&&o(e.closest(".accordion-header").closest(".accordion-item"),"active")}}})),d("#toggle_all_checkbox").addEventListener("change",w),I={showChangelogLink:!1},T=t=>{t.showChangelogLink&&function(t){const e=d(t);e&&(e.hidden=!1)}(".changelog-link")},chrome.storage.sync.get(I,T)})();
//# sourceMappingURL=main.bundle.js.map