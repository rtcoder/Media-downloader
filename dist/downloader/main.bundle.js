(()=>{"use strict";function t(t,e,n=null){let i=[];i="string"==typeof t?function(t){const e=[],n=document.querySelectorAll(t);return n.forEach((t=>e.push(t))),n}(t):Array.isArray(t)?[...t]:[t],i.length&&(null===n?[...i].forEach((t=>{t.classList.contains(e)?t.classList.remove(e):t.classList.add(e)})):n?[...i].forEach((t=>t.classList.add(e))):[...i].forEach((t=>t.classList.remove(e))))}function e(t,e={},n=[]){const i=document.createElement(t);if(e.class&&("string"==typeof e.class?i.classList.add(e.class):i.classList.add(...e.class)),e.html&&(i.innerHTML=e.html||""),e.attributes)for(const[t,n]of Object.entries(e.attributes))i.setAttribute(t,n);if(e.data)for(const[t,n]of Object.entries(e.data))i.setAttribute(`data-${t}`,n);return e.type&&(i.type=e.type),e.title&&(i.title=e.title),e.alt&&(i.alt=e.alt),e.src&&(i.src=e.src),n&&(!Array.isArray(n)&&n instanceof HTMLElement&&(n=[n]),i.append(...n)),i}function n(t={},n=[]){return e("div",t,n)}function i(t={},n=[]){return e("span",t,n)}function o(t={},n=[]){return t.type="button",e("button",t,n)}function c(t={}){return e("img",t)}function s(t,e=24){return i({html:t,class:"x-icon",attributes:{size:e}})}function a(t){return document.querySelector(t)}function r(){return n({class:"thumbnail"})}function d(t,a){const{src:d,alt:l,poster:u,type:h,selected:f}=t,m=n({class:["grid-item",...f?["checked"]:[]],attributes:{"data-src-dw":d,"data-filename":(null==l?void 0:l.length)?l:"","data-item-idx":a,"data-type":h}}),b=o({class:"download_image_button"},s("download")),g=i({class:"item-details"},[i({class:"item-details-ext"}),i({class:"item-details-dimensions"})]);let p=null;"audio"===h?p=function(t){const n=r(),i=s("music_note",50),o=e("audio",{src:t});return o.addEventListener("loadedmetadata",(()=>{const t=function(t){const e=Math.floor(t%60),n=Math.floor(t%3600/60),i=Math.floor(t/3600),o=e<10?`0${e}`:e,c=n<10?`0${n}`:n;return i>0?`${i}:${c}:${o}`:`${c}:${o}`}(o.duration),e=o.closest(".grid-item");null==e||e.setAttribute("duration",t),o.remove()})),n.appendChild(i),n.appendChild(o),n}(d):"image"===h?p=function(t){const e=r(),n=c({src:t});return n.addEventListener("load",(()=>{const t=n.naturalWidth.toString(),e=n.naturalHeight.toString(),i=n.closest("grid-item");null==i||i.setAttribute("original-width",t),null==i||i.setAttribute("original-height",e)})),e.appendChild(n),e}(d):"video"===h&&(p=function(t,n){const i=r(),o=s("videocam",50),a=c({src:n}),d=e("video",{src:t,poster:n});return d.addEventListener("loadedmetadata",(()=>{const t=(e=d.videoWidth)>=3840?"4K":e>=2560?"1440p":e>=1920?"1080p":e>=1280?"720p":e>=854?"480p":e>=640?"360p":"SD";var e;const n=d.closest("grid-item");null==n||n.setAttribute("video-quality",t),d.remove()})),i.appendChild(n?a:o),i.appendChild(d),i}(d,u)),m.appendChild(b),m.appendChild(g),p&&m.appendChild(p);const v=new MutationObserver((t=>{t.forEach((t=>{"attributes"===t.type&&function(t,e,n){const i=t.querySelector(".item-details"),o=i.querySelector(".item-details-dimensions"),c=t.getAttribute("extension"),s=t.getAttribute("duration"),a=t.getAttribute("width"),r=t.getAttribute("height"),d=t.getAttribute("quality");switch(c&&(i.querySelector(".item-details-ext").textContent=c),e){case"audio":o.textContent=s,c&&s&&n.disconnect();break;case"image":o.textContent=`${a} x ${r}`,c&&a&&r&&n.disconnect();break;case"video":o.textContent=d,c&&d&&n.disconnect()}}(m,h,v)}))}));return v.observe(m,{attributes:!0,attributeFilter:["duration","quality","extension","width","height"]}),m}const l=[],u={};function h(){const t=a(".section-buttons button.selected").getAttribute("data-section")||"images",e=t=>({type:e,selected:n,src:i,poster:o})=>({src:i,poster:o,filetype:e,selected:n,type:t}),n={images:t=>t.images.map(e("image")),videos:t=>t.videos.map(e("video")),audios:t=>t.audios.map(e("audio"))}[t]||(()=>[]);return l.map((({media:t,tab:e})=>({tab:e,items:n(t),showHeader:!0})))}function f(){const t=h();console.log(t),function(t){const e=a(".accordion");t.forEach((t=>{const s=t.tab.id,a=function(t,e){return t.querySelector(`.accordion-item[tab-id="${e}"]`)}(e,s);a?t.items.forEach(((t,e)=>{const n=`${s}-${e}`,i=function(t,e){return t.querySelector(`.grid-item[data-item-idx="${e}"]`)}(a,n);i||a.querySelector(".accordion-body").appendChild(d(t,n))})):e.appendChild(function(t,e=!1){const{favIconUrl:s,title:a,id:r}=t.tab,l=n({class:"accordion-item"});l.setAttribute("tab-id",r);const u=(f=s,m=a,b=t.items.length,n({class:["accordion-header","active"]},o({class:"accordion-button"},[c({src:f,class:"favicon",alt:"Favicon"}),i({class:"tab-title"},[i({class:"title",html:m}),i({class:"tab-media-count",html:b})]),i({class:"tab-toggle"})]))),h=function(t,e,i){return n({class:"accordion-body",hidden:!i},t.map(((t,n)=>d(t,`${e}-${n}`))))}(t.items,r,e);var f,m,b;return t.showHeader||(u.hidden=!0),l.appendChild(u),l.appendChild(h),l}(t))}))}(t),a(".count-all").innerHTML=function(t){return t.reduce(((t,e)=>t+e.items.length),0)}(t).toString()}function m(t,e){u[t]=e}var b;!function(t){t.TAB_CREATED="tabCreated",t.TAB_REPLACED="tabReplaced",t.TAB_UPDATED="tabUpdated",t.TAB_ACTIVATED="tabActivated",t.SEND_MEDIA="sendMedia"}(b||(b={}));var g=function(t,e,n,i){return new(n||(n=Promise))((function(o,c){function s(t){try{r(i.next(t))}catch(t){c(t)}}function a(t){try{r(i.throw(t))}catch(t){c(t)}}function r(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}r((i=i.apply(t,e||[])).next())}))};function p(){return g(this,void 0,void 0,(function*(){var t;let[e]=yield chrome.tabs.query({active:!0,lastFocusedWindow:!0});return(null===(t=null==e?void 0:e.url)||void 0===t?void 0:t.startsWith("chrome://"))?null:e}))}function v(t){!function(t,e=null){const n={url:t};e&&(n.filename=e),chrome.downloads.download(n)}(t.url,t.alt)}var y=function(t,e,n,i){return new(n||(n=Promise))((function(o,c){function s(t){try{r(i.next(t))}catch(t){c(t)}}function a(t){try{r(i.throw(t))}catch(t){c(t)}}function r(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}r((i=i.apply(t,e||[])).next())}))};const A=["images","audios","videos"],E=["https://youtube.com","https://www.youtube.com"];var w;function x(t,e){return y(this,arguments,void 0,(function*(t,e,n=null){var i;n||(n=yield p()),n&&((null===(i=null==n?void 0:n.url)||void 0===i?void 0:i.startsWith("chrome://"))||n.active&&"complete"===e.status&&L())}))}function C(e){const{checked:n}=e.target;let i=!0,o=!0;const c=h();let s=0;t(".grid-item","checked",n);for(let t=0;t<c.length;t++){const{items:e}=c[t];for(let t=0;t<e.length;t++)e[t].selected=n,e[t].selected?(o=!1,s++):i=!1}_(s);const r=a("#toggle_all_checkbox");r.indeterminate=!(i||o),i?r.checked=!0:o&&(r.checked=!1)}function _(t){var e;a("#download-btn .selected-count").innerHTML=t>0?`(${t})`:"",e=!t,a("#download-btn").disabled=e}function L(){!function(){g(this,void 0,void 0,(function*(){const t=yield p();t&&t.id&&(t.id<=0||(yield chrome.scripting.executeScript({target:{tabId:t.id,allFrames:!0},files:["/dist/content-script/send_media.bundle.js"]})))}))}()}w=(t,e,n)=>{const{eventName:i,data:o}=t;switch(console.log(i,o),i){case b.TAB_UPDATED:x(o.tabId,o.changeInfo,o.tab);break;case b.TAB_ACTIVATED:case b.TAB_CREATED:case b.TAB_REPLACED:const{tabId:t,changeInfo:e,tab:n}=o;x(t,e,n);break;case b.SEND_MEDIA:!function(t){y(this,void 0,void 0,(function*(){if(t.error&&Object.keys(t.error).length>0)return void console.log(t);const e=yield p();var n;e&&(function(){const t=a(".yt-info");t&&(t.hidden=!0)}(),n=e.url,E.some((t=>n.includes(t)))?function(){const t=a(".yt-info");t&&(t.hidden=!1)}():(A.filter((e=>!!t[e])).forEach((n=>{const i={images:[],videos:[],audios:[]};t[n].filter((t=>!i[n].includes(t))).forEach((t=>i[n].push(t)));const{id:o,favIconUrl:c,url:s,title:a}=e,r=l.findIndex((({tab:t})=>t.id===o)),d={id:o,favIconUrl:c,url:s,title:a};if(-1===r)l.push({media:i,tab:d});else{const{media:t}=l[r];A.forEach((e=>{var n;l[r].media[e]=(n=[...t[e],...i[e]],[...new Map(n.map((t=>[t.src,t]))).values()]),l[r].tab=d}))}l.forEach((t=>m(t.tab.id,!1))),m(o,!0)})),f()))}))}(o)}},chrome.runtime.onMessage.addListener(w),L(),document.body.addEventListener("click",(e=>{const{target:n}=e;if(n)if(n.closest("#download-btn"))!function(t){const e=[];for(let n=0;n<t.length;n++){const{items:i}=t[n];for(let t=0;t<i.length;t++)i[t].selected&&e.push({url:i[t].src,alt:i[t].alt})}e.forEach(v)}(h());else{if(n.closest(".section-buttons button"))return i=n.closest(".section-buttons button").getAttribute("data-section"),i=A.includes(i)?i:"images",t(".section-buttons button","selected",!1),t(`.section-buttons button[data-section="${i}"]`,"selected",!0),void f();var i;if(n.matches(".thumbnail"))!function(e){const n=e.closest(".grid-item"),i=n.getAttribute("data-item-idx"),o=n.getAttribute("data-type"),c=!n.classList.contains("checked");t(n,"checked");const[s,r]=i.split("-").map((t=>+t)),d=function(t){return"image"===t?"images":"video"===t?"videos":"audios"}(o),u=l.findIndex((({tab:t})=>t.id===s));if(-1===u)return;l[u].media[d][r].selected=c;let f=!0,m=!0;const b=h();let g=0;console.log(i,c);for(let t=0;t<b.length;t++){const{items:e}=b[t];for(let t=0;t<e.length;t++)e[t].selected?(m=!1,g++):f=!1}_(g);const p=a("#toggle_all_checkbox");p.indeterminate=!(f||m),f?p.checked=!0:m&&(p.checked=!1)}(n);else if(n.matches(".accordion-header")||n.closest(".accordion-button"))n.closest(".accordion-item").classList.toggle("active");else if(n.matches(".yt-info a"))window.open("https://developer.chrome.com/docs/webstore/troubleshooting/#prohibited-products");else if(n.matches(".download_image_button")){const t=n.closest(".grid-item"),e=t.getAttribute("data-src-dw"),i=t.getAttribute("data-filename");v({url:e,alt:(null==i?void 0:i.length)?i:null})}}})),a("#toggle_all_checkbox").addEventListener("change",C)})();